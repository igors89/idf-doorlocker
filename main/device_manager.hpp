#pragma once
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"
#include "esp_err.h"
#include "esp_log.h"
#include "esp_timer.h"
#include "driver/gpio.h"
#include "esp_timer.h"
#include "driver/touch_pad.h"
#include "touch_element/touch_button.h"
#include "event_bus.hpp"
#include "storage_manager.hpp"
#include "esp_mac.h"
#include <stdio.h>
#include <string.h>
// #include "driver/i2c.h"
#include "esp_heap_caps.h"
// #include "qrcodegen.h"


namespace DeviceManager
{
    esp_err_t init();
    static void init_gpios();
    static void init_touch();
    static void init_display();
    static void init_buzzer();
    static void init_sensor();
    //buzzer
    static void buzzer_timer_cb(void*);
    //qrcode
    static void generate_and_draw_wifi_qr_to_screen_n(uint8_t screen_num);
    //devices
    static void handlerDev(uint8_t dev_id);
    static void touch_event_cb(touch_button_handle_t handle, touch_button_message_t *msg, void *arg);
    static void touch_task(void*);
    static void timer_callback(void* arg);
    //sensors
    static void init_sensor_timer_cb(void* arg);
    static void sensor_isr(void* arg);
    static void sensor_task(void* arg);
    //display
    static void create_draw_queue_in_psram(size_t queue_length);
    static void draw_buffer_send_safe(uint8_t screen_num);
    static void write_cmd(uint8_t cmd);
    static void draw_icon(uint8_t screen_num,const uint8_t *icon,uint16_t icon_w,uint16_t icon_h,uint16_t x0,uint16_t y0);
    static void display_event_task(void* pv);
    static void batch_timer_cb(void*);
    static void write_data(const uint8_t *data, size_t len);
    static void display_timer_cb(void*);
    //eventos
    static void storage_event_task(void* arg);
    static void onStorageEvent(void*, esp_event_base_t, int32_t id, void* event_data);
    static void onReadyEvent(void*, esp_event_base_t, int32_t id, void*);
    static void onNetworkEvent(void*, esp_event_base_t, int32_t id, void*);
};
const uint8_t init_cmds[] = {
  0xAE, 0x20, 0x10, 0xB0, 0xC8, 0x00, 0x10, 0x40, 0x81, 0x7F, 0xA1, 0xA6, 0xA8, 0x3F, 0xA4, 0xD3, 0x00, 0xD5, 0x80, 0xD9, 0xF1, 0xDA,
  0x12, 0xDB, 0x40, 0x8D, 0x14, 0xAF};
// H 19 x W 15
const uint8_t DEV1_OFF[] = {
  0xFF, 0xFE, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0x81, 0x02, 0x83, 0x02, 0x85, 0x02, 0x89, 0x02, 0x81, 0x02, 0x81, 0x02, 0x81, 0x02,
  0x81, 0x02, 0x81, 0x02, 0x81, 0x02, 0x8F, 0xE2, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0xFF, 0xFE,};
const uint8_t DEV1_ON[] = {
  0xFF, 0xFE, 0x80, 0x02, 0xBF, 0xFA, 0xBF, 0xFA, 0xBE, 0xFA, 0xBC, 0xFA, 0xBA, 0xFA, 0xB6, 0xFA, 0xBE, 0xFA, 0xBE, 0xFA, 0xBE, 0xFA,
  0xBE, 0xFA, 0xBE, 0xFA, 0xBE, 0xFA, 0xB0, 0x1A, 0xBF, 0xFA, 0xBF, 0xFA, 0x80, 0x02, 0xFF, 0xFE,};
const uint8_t DEV2_OFF[] = {
  0xFF, 0xFE, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0x8F, 0xE2, 0x80, 0x22, 0x80, 0x22, 0x80, 0x22, 0x80, 0x22, 0x8F, 0xE2, 0x88, 0x02,
  0x88, 0x02, 0x88, 0x02, 0x88, 0x02, 0x8F, 0xE2, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0xFF, 0xFE,};
const uint8_t DEV2_ON[] = {
  0xFF, 0xFE, 0x80, 0x02, 0xBF, 0xFA, 0xBF, 0xFA, 0xB0, 0x1A, 0xBF, 0xDA, 0xBF, 0xDA, 0xBF, 0xDA, 0xBF, 0xDA, 0xB0, 0x1A, 0xB7, 0xFA,
  0xB7, 0xFA, 0xB7, 0xFA, 0xB7, 0xFA, 0xB0, 0x1A, 0xBF, 0xFA, 0xBF, 0xFA, 0x80, 0x02, 0xFF, 0xFE,};
const uint8_t DEV3_OFF[] = {
  0xFF, 0xFE, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0x8F, 0xE2, 0x80, 0x22, 0x80, 0x22, 0x80, 0x22, 0x80, 0x22, 0x8F, 0xE2, 0x80, 0x22,
  0x80, 0x22, 0x80, 0x22, 0x80, 0x22, 0x8F, 0xE2, 0x80, 0x02, 0x80, 0x02, 0x80, 0x02, 0xFF, 0xFE,};
const uint8_t DEV3_ON[] = {
  0xFF, 0xFE, 0x80, 0x02, 0xBF, 0xFA, 0xBF, 0xFA, 0xB0, 0x1A, 0xBF, 0xDA, 0xBF, 0xDA, 0xBF, 0xDA, 0xBF, 0xDA, 0xB0, 0x1A, 0xBF, 0xDA,
  0xBF, 0xDA, 0xBF, 0xDA, 0xBF, 0xDA, 0xB0, 0x1A, 0xBF, 0xFA, 0xBF, 0xFA, 0x80, 0x02, 0xFF, 0xFE,};
// H 19 x W 38
const uint8_t SEN_ON[] = {
  0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x80, 0x00, 0x00, 0x00, 0x04, 0xBF, 0xFF, 0xFF, 0xFF, 0xF4, 0xBF, 0xFF, 0xFF, 0xFF, 0xF4,
  0xB0, 0x1C, 0x07, 0x7F, 0xB4, 0xB7, 0xFD, 0xFF, 0x3F, 0xB4, 0xB7, 0xFD, 0xFF, 0x1F, 0xB4, 0xB7, 0xFD, 0xFF, 0x4F, 0xB4,
  0xB7, 0xFD, 0xFF, 0x67, 0xB4, 0xB0, 0x1C, 0x07, 0x73, 0xB4, 0xBF, 0xDD, 0xFF, 0x79, 0xB4, 0xBF, 0xDD, 0xFF, 0x7C, 0xB4,
  0xBF, 0xDD, 0xFF, 0x7E, 0x34, 0xBF, 0xDD, 0xFF, 0x7F, 0x34, 0xB0, 0x1C, 0x07, 0x7F, 0xB4, 0xBF, 0xFF, 0xFF, 0xFF, 0xF4, 
  0xBF, 0xFF, 0xFF, 0xFF, 0xF4, 0x80, 0x00, 0x00, 0x00, 0x04, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,};
const uint8_t SEN_OFF[] = {
  0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0x80, 0x00, 0x00, 0x00, 0x04, 0x80, 0x00, 0x00, 0x00, 0x04, 0x80, 0x00, 0x00, 0x00, 0x04,
  0x8F, 0xE3, 0xF8, 0x80, 0x44, 0x88, 0x02, 0x00, 0xC0, 0x44, 0x88, 0x02, 0x00, 0xE0, 0x44, 0x88, 0x02, 0x00, 0xB0, 0x44,
  0x88, 0x02, 0x00, 0x98, 0x44, 0x8F, 0xE3, 0xF8, 0x8C, 0x44, 0x80, 0x22, 0x00, 0x86, 0x44, 0x80, 0x22, 0x00, 0x83, 0x44,
  0x80, 0x22, 0x00, 0x81, 0xC4, 0x80, 0x22, 0x00, 0x80, 0xC4, 0x8F, 0xE3, 0xF8, 0x80, 0x44, 0x80, 0x00, 0x00, 0x00, 0x04,
  0x80, 0x00, 0x00, 0x00, 0x04, 0x80, 0x00, 0x00, 0x00, 0x04, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC,};
// H 15 x W 9
const uint8_t HR_1[] = {
  0x08, 0x00, 0x18, 0x00, 0x28, 0x00, 0x48, 0x00, 0x88, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00,
  0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0xFF, 0x80,};
const uint8_t HR_2[] = {
  0xFF, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x00,
  0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80,};
const uint8_t HR_3[] = {
  0xFF, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0xFF, 0x80, 0x00, 0x80, 0x00, 0x80,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0xFF, 0x80,};
const uint8_t HR_4[] = {
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x00, 0x80, 0x00, 0x80,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80,};
const uint8_t HR_5[] = {
  0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80, 0x00, 0x80, 0x00, 0x80,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0xFF, 0x80,};
const uint8_t HR_6[] = {
  0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80,};
const uint8_t HR_7[] = {
  0xFF, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80,};
const uint8_t HR_8[] = {
  0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80 ,};
const uint8_t HR_9[] = {
  0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x00, 0x80, 0x00, 0x80,
  0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80,};
const uint8_t HR_0[] = {
  0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80,};
// H 15 x W 2
const uint8_t HR__[] = {
  0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00,};
// H 15 x W 9
const uint8_t D_[] = {
  0xF8, 0x00, 0x84, 0x00, 0x82, 0x00, 0x81, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x81, 0x00, 0x82, 0x00, 0x84, 0x00, 0xF8, 0x00,};
const uint8_t E_[] = {
  0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 
  0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80,};
const uint8_t V_[] = {
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x22, 0x00, 0x22, 0x00, 0x22, 0x00, 0x14, 0x00, 
  0x14, 0x00, 0x14, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00,};
const uint8_t A_[] = {
  0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,};
const uint8_t P_[] = {
  0xFF, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x00,
  0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00,};
const uint8_t W_[] = {
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x88, 0x80, 0x88, 0x80, 0x9C, 0x80, 0x94, 0x80, 0x94, 0x80, 0xB6, 0x80, 0xA2, 0x80, 
  0xA2, 0x80, 0xE3, 0x80, 0xC1, 0x80, 0xC1, 0x80, 0xC1, 0x80,};
const uint8_t I_[] = {
  0xFF, 0x80, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 
  0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0x08, 0x00, 0xFF, 0x80,};
const uint8_t F_[] = {
  0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x00, 
  0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x00,};