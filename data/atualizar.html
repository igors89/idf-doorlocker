<!DOCTYPE html>
<html>
  <head>
    <title>IA Solucoes</title>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/igra.css">
  </head>
  <body>
    <script src="/js/icons.js"></script>
    <script src="/js/messages.js"></script>
    <script>
      window.onload=function(){
        // permissão de acesso
        if(sessionStorage.getItem("autenticado")!=="sim"){window.location.href="index.html";return;}
        // variáveis
        const socket=new WebSocket(`ws://${location.host}/ws`);
        const index=document.getElementById("divIndex");
        const painel=document.getElementById("divPainel");
        const progresso=document.getElementById("divProgress");
        const firmware=document.getElementById("divFirmware");
        const aguarde=document.getElementById("divAguarde");
        const aviso=document.getElementById("divAviso");
        const newFirmware=document.getElementById("divNewFirmware");
        const msgFirmware=document.getElementById("divMsgFirmware");
        const progressBarFill=document.getElementById('progressBar-fill');
        const progressText=document.getElementById('progressText');
        const btnFirmware=document.getElementById('divBtnFirmware');
        let atuadores={};
        // comportamentos
        document.getElementById('btnCancelar').addEventListener("click",getCancel);
        document.getElementById('btnSair').addEventListener("click",getCancel);
        document.getElementById('btnFabrica').addEventListener("click",getFabrica);
        socket.addEventListener('open',function(event){socket.send("FRM");});
        // funções
        function showDiv(id){
          document.querySelectorAll('.util').forEach(div=>{div.style.display=(div.id===id)?'flex':'none';});
        }
        function showMessage(message){
          document.getElementById('divResultado').innerHTML=message;
          showDiv('divAviso');
        }
        function getCancel(){
          event.preventDefault();
          window.location.href=`index.html`;
        }
        function getFabrica(){
          if(confirm('Atualizar para firmware de fábrica?')){socket.send('RST');showDiv('divAguarde');}
        }
        document.addEventListener('click', function(e) {
          var a=e.target.closest&&e.target.closest('.ota-link');
          if(!a)return;
          e.preventDefault();
          var fname=a.getAttribute('data-filename');
          newFirmware.innerHTML='Instalando: '+fname;
          if(confirm('Atualizar para firmware: '+fname+'?')){socket.send('OTA:'+fname);showDiv('divProgress');}
        });
        socket.onmessage=function(event){
          try{
            if(event.data.startsWith("keep")){
              socket.send("alive");
            }else if(event.data.startsWith("firmware")){
              painel.innerHTML='';
              painel.innerHTML=event.data.substring(8);
            }else if(event.data.startsWith("progress")){
              const progress=parseInt(event.data.substring(8));
              if(progress>=0&&progress<=100){
                progressBarFill.style.width=`${progress}%`;
                progressText.textContent=`${progress}%`;
              }
              if(progress==100){
                btnFirmware.style.display='flex'
              }
            }else if(event.data.startsWith("msgFirmware")){
              msgFirmware.innerHTML='';
              msgFirmware.innerHTML=event.data.substring(11);
            }else if(event.data.startsWith("sendFrmAtual")){
              firmware.innerHTML='';
              firmware.innerHTML=event.data.substring(12);
            }else if(event.data.startsWith("sendFabrica")){
              if(event.data.substring(11)=="OK"){showMessage("Reiniciando para fábrica, pode fechar esta página!");}
              else{showMessage("Erro no reset para fábrica, reinicie o processo!");}
            }
          }catch(e){console.error("Erro ao processar mensagem WS:",e);}
        };
        // inicialização
        showDiv('divIndex');
        btnFirmware.style.display='none'
        document.getElementById("iconCancelar").innerHTML=icons["exit"];
        document.getElementById("iconSair").innerHTML=icons["exit"];
        document.getElementById("iconFabrica").innerHTML=icons["alert_triangle"];
        document.getElementById("iconAguarde").innerHTML=icons["refresh_cw"];
      };
    </script>
    <div id="divTopo" class="topo"><h2>Sistema de Automação</h2></div>
    <div id="divIndex" class="util">
      <div id="divFirmware" class="in_util"></div><br>
      <div class="in_util"><h4>Firmwares Disponíveis</h4></div><br>
      <div id="divPainel" class="in_util"></div>
      <div class="form-group">
        <button type="button" id="btnCancelar" class="btn-custom"><span id="iconCancelar"></span>Cancelar</button>
      </div>
      <div class="form-group">
        <button type="button" id="btnFabrica" class="btn-custom"><span id="iconFabrica"></span>Reset Fábrica</button>
      </div>
    </div>
    <div id="divProgress" class="util">
      <div id="divNewFirmware" class="in_util"></div><br>
      <h4>Progresso da Atualização</h4>
      <div id="progressBar"><div id="progressBar-fill"></div></div>
      <p id="progressText">0%</p>
      <br><div id="divMsgFirmware" class="in_util"></div><br>
      <div id="divBtnFirmware" class="in_util">
        <div class="form-group">
          <button type="button" id="btnSair" class="btn-custom"><span id="iconSair"></span>Sair</button>
        </div>
      </div>
    </div>
    <div class="util" id="divAguarde"><div id="iconAguarde"></div></div>
    <div class="util" id="divAviso"><br><br><h3>Aviso Importante</h3><br><div id="divResultado" class="message"></div></div>
    <div class="rodape" id="divRodape"><img src="/img/logomarca" width="40px" height="40px"></div>
  </body>
</html>